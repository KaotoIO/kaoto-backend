apiVersion: camel.apache.org/v1alpha1
kind: Kamelet
metadata:
  annotations:
    camel.apache.org/kamelet.support.level: Preview
    camel.apache.org/catalog.version: main-SNAPSHOT
    camel.apache.org/kamelet.icon: whatever
    camel.apache.org/provider: Apache Software Foundation
    camel.apache.org/kamelet.group: Kaoto
  labels:
    camel.apache.org/kamelet.type: action
  name: eip-action
spec:
  definition:
    title: EIP Kamelet
    description: Used to test all EIP we implement
    properties: {}
  dependencies:
  - camel:core
  - camel:kamelet
  template:
    from:
      uri: kamelet:source
      steps:
      - loop:
          constant: '3'
          copy: true
          steps:
          - delay:
              expression:
                simple: ${body}
              async-delayed: true
      - choice:
          when:
          - simple: '{{?foo}}'
            steps:
            - dynamic-router:
                expression:
                  simple: ${body}
                description:
                  text: Dynamic Routing
                  lang: eng
            - set-header:
                name: bar
                simple: foo
            - marshal:
                json:
                  library: Gson
            - circuit-breaker:
                configuration: config
                description:
                  text: Test circuit breaker
                  lang: eng
                steps:
                - to:
                    uri: dropbox:put
                    parameters:
                      remotePath: '{{remotePath}}'
                      clientIdentifier: '{{clientIdentifier}}'
                      uploadMode: '{{uploadMode}}'
                - poll-enrich:
                    expression:
                      simple: ${body}
                    aggregation-strategy: myStrategy
                on-fallback:
                  steps:
                  - log:
                      message: test
                      logging-level: INFO
                      log-name: yaml
                  - convert-body-to:
                      type: java.lang.String
                      charset: UTF8
          - simple: '{{?bar}}'
            steps:
            - unmarshal:
                json:
                  unmarshal-type-name: MyClass
            - set-property:
                name: property
                simple: bar
            - split:
                steps:
                - remove-property:
                    name: property
                tokenize: ','
            - split:
                simple: ${body}
                steps:
                - marshal:
                    json: {}
            - claim-check:
                operation: Get
                key: foo
                filter: header:(foo|bar)
          - simple: '{{?baz}}'
            steps:
            - enrich:
                expression:
                  simple: ${body}
            - transform:
                simple: baz
            - aggregate:
                correlation-expression:
                  simple: ${header.StockSymbol}
                aggregation-strategy: myAggregatorStrategy
                completion-size: 2
            - log:
                message: test
                logging-level: INFO
                log-name: yaml
          otherwise:
            steps:
            - set-body:
                simple: ola ke ase
            - remove-header:
                name: removeme
      - filter:
          simple: '{{?foo}}'
          steps:
          - set-body:
              simple: abc
      - to:
          uri: kamelet:sink
